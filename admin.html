<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة الأدمن — Aya Elsayed</title>
  <link rel="stylesheet" href="style.css">

  <style>
body {
  font-family: "Tajawal", sans-serif;
  background: #fff7fb;
  margin: 0;
  padding: 0;
}

.header {
  background: #ff7aa8;
  padding: 15px;
  color: #fff;
  text-align: center;
  font-size: 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.container {
  padding: 20px;
}

.btn {
  background: #ff7aa8;
  padding: 8px 14px;
  border: none;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
}

.btn:hover {
  background: #ff5c90;
}

.table {
  width: 100%;
  margin-top: 10px;
  border-collapse: collapse;
}

.table th {
  background: #ff9fbc;
  color: white;
  padding: 10px;
  text-align: center;
}

.table td {
  padding: 10px;
  border-bottom: 1px solid #ffd7e8;
  text-align: center;
}

/* جدول الطلبات */
.orders-table {
  width: 100%;
  border-collapse: collapse;
  background: #ffffff;
  margin-top: 12px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(255, 157, 185, 0.2);
}

.orders-table th {
  background: #ff9fbc;
  color: #fff;
  padding: 12px;
  font-weight: bold;
}

.orders-table td {
  padding: 12px;
  border-bottom: 1px solid #ffe3ef;
}

.orders-table tr:hover {
  background: #fff1f7;
}

.status-select {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ffb6cf;
  background: #fff;
  font-size: 14px;
  cursor: pointer;
}

.delete-btn {
  background: #ff5f7e;
  border: none;
  padding: 6px 10px;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}

.delete-btn:hover {
  background: #e04361;
}

/* العدادات */
.stats-box {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.stats-item {
  background: #ffe3ef;
  padding: 15px 20px;
  border-radius: 10px;
  flex: 1;
  text-align: center;
  box-shadow: 0 2px 8px rgba(255, 145, 170, 0.2);
}

.stats-item b {
  color: #ff2f77;
  font-size: 22px;
}
  </style>

</head>

<body>

<header class="header">
  <h1>لوحة الأدمن — Aya Elsayed</h1>
  <div><a href="index.html" style="color:#fff">عرض المتجر</a></div>
</header>

<div class="container">
  <div id="adminArea"><p>جارٍ التحقق...</p></div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

const SECRET = "Alosh123@@@";
const params = new URLSearchParams(location.search);
const token = params.get("token");
const adminArea = document.getElementById("adminArea");

if (token !== SECRET) {
  adminArea.innerHTML = `<p style="color:red">رمز الدخول غير صحيح ❌</p>`;
  throw new Error("Unauthorized");
}

adminArea.innerHTML = `
  <div class="admin-header">
    <h2>إدارة المنتجات والطلبات</h2>
    <button id="refresh" class="btn">تحديث</button>
  </div>

  <!-- عدادات -->
  <div class="stats-box">
    <div class="stats-item">المنتجات: <b id="countProducts">0</b></div>
    <div class="stats-item">الطلبات: <b id="countOrders">0</b></div>
    <div class="stats-item">الطلبات الجديدة: <b id="countNewOrders">0</b></div>
  </div>

  <section style="margin-bottom:12px">
    <h3>إضافة منتج جديد</h3>
    <form id="addProduct" style="display:grid;gap:8px;max-width:600px">
      <input id="title" placeholder="اسم المنتج" required>
      <textarea id="desc" placeholder="وصف المنتج"></textarea>
      <input id="price" type="number" placeholder="السعر (جنيه)" required>
      <label>صورة المنتج:</label>
      <input id="imageFile" type="file" accept="image/*">
      <button class="btn" type="submit">إضافة</button>
    </form>
  </section>

  <section>
    <h3>المنتجات</h3>
    <table class="table" id="productsTable">
      <thead>
        <tr><th>المنتج</th><th>السعر</th><th>إدارة</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top:18px">
    <h3>الطلبات</h3>

    <!-- فلتر الحالة -->
    <label>فرز حسب الحالة:</label>
    <select id="filterStatus" class="status-select">
      <option value="all">الكل</option>
      <option value="new">جديد</option>
      <option value="processing">جاري التجهيز</option>
      <option value="done">تم التسليم</option>
    </select>

    <table class="orders-table" id="ordersTable">
      <thead>
        <tr>
          <th>العميل</th>
          <th>الهاتف</th>
          <th>الطلب</th>
          <th>المجموع</th>
          <th>الحالة</th>
          <th>إدارة</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
`;

const addProductForm = document.getElementById("addProduct");
const productsTable = document.querySelector("#productsTable tbody");
const ordersTable = document.querySelector("#ordersTable tbody");
const refreshBtn = document.getElementById("refresh");
const filterStatus = document.getElementById("filterStatus");

// العدادات
const countProducts = document.getElementById("countProducts");
const countOrders = document.getElementById("countOrders");
const countNewOrders = document.getElementById("countNewOrders");

async function loadAdmin() {

  /* تحميل المنتجات */
  const { data: products } = await supabase
    .from("products")
    .select("*")
    .order("id", { ascending: false });

  countProducts.textContent = products.length;

  productsTable.innerHTML = products
    .map(
      (p) => `
    <tr>
      <td>${p.title}</td>
      <td>${p.price}</td>
      <td>
        <button class="btn" data-del-product="${p.id}">حذف</button>
      </td>
    </tr>`
    ).join("");

  document.querySelectorAll("[data-del-product]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.delProduct;
      if (!confirm("حذف المنتج؟")) return;
      await supabase.from("products").delete().eq("id", id);
      loadAdmin();
    });
  });

  /* تحميل الطلبات */
  let query = supabase.from("orders").select("*");

  if (filterStatus.value !== "all") {
    query = query.eq("status", filterStatus.value);
  }

  const { data: orders } = await query.order("id", { ascending: false });

  countOrders.textContent = orders.length;
  countNewOrders.textContent = orders.filter(o => o.status === "new").length;

  ordersTable.innerHTML = orders
    .map(
      (o) => `
<tr>
  <td>${o.customer_name}</td>
  <td>${o.phone}</td>
  <td>${(o.items || []).map(i => `${i.title} × ${i.quantity}`).join("<br>")}</td>
  <td>${o.total} جنيه</td>

  <td>
    <select class="status-select" data-id="${o.id}">
      <option value="new" ${o.status === "new" ? "selected" : ""}>جديد</option>
      <option value="processing" ${o.status === "processing" ? "selected" : ""}>جاري التجهيز</option>
      <option value="done" ${o.status === "done" ? "selected" : ""}>تم التسليم</option>
    </select>
  </td>

  <td>
    <button class="delete-btn" data-del-order="${o.id}">حذف</button>
  </td>
</tr>`
    ).join("");

  /* تغيير الحالة */
  document.querySelectorAll(".status-select").forEach((select) => {
    select.addEventListener("change", async () => {
      const id = select.dataset.id;
      const value = select.value;
      await supabase.from("orders").update({ status: value }).eq("id", id);
    });
  });

  /* حذف الطلب */
  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.delOrder;
      if (!confirm("حذف الطلب؟")) return;
      await supabase.from("orders").delete().eq("id", id);
      loadAdmin();
    });
  });

}

refreshBtn.addEventListener("click", loadAdmin);
filterStatus.addEventListener("change", loadAdmin);

loadAdmin();

/* إضافة منتج */
addProductForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("title").value.trim();
  const desc = document.getElementById("desc").value.trim();
  const price = document.getElementById("price").value;
  const file = document.getElementById("imageFile").files[0];

  let finalImageUrl = null;

  if (file) {
    const fileName = "products/" + Date.now() + "_" + file.name;

    await supabase.storage.from("products-images").upload(fileName, file);

    const { data } = supabase.storage
      .from("products-images")
      .getPublicUrl(fileName);

    finalImageUrl = data.publicUrl;
  }

  await supabase.from("products").insert([
    { title, description: desc, price, image_url: finalImageUrl },
  ]);

  alert("✔ تم إضافة المنتج");
  addProductForm.reset();
  loadAdmin();
});
</script>

</body>
</html>
